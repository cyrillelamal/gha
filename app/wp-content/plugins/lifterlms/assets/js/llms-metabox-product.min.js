!function(c){window.llms=window.llms||{},window.llms.metabox_product=function(){this.$plans=null,this.$save=null,this.temp_id=Math.floor(7777*Math.random()+777),this.validation_class="llms-invalid",this.init=function(e){var t,a,l=this,s=(l.$plans=c("#llms-access-plans"),l.$save=c("#llms-save-access-plans"),l.bind_visibility(),c("#lifterlms-product #llms-product-options-access-plans"));s.length&&(e?l.bind():(LLMS.Spinner.start(s),t=0,a=setInterval(function(){if(300<=t)s.html(LLMS.l10n.translate("There was an error loading the necessary resources. Please try again."));else{if("undefined"==typeof tinyMCE)return void t++;l.bind()}clearInterval(a),LLMS.Spinner.stop(s)},100)))},this.bind=function(){var l=this;setTimeout(function(){l.has_plan_limit_been_reached()&&l.toggle_create_button("disable")},500),0===l.get_current_plan_count()&&l.toggle_save_button("disable"),l.$save.on("click",function(e){e.preventDefault(),l.save_plans()}),l.$plans.on("change","[data-controller-id]",function(){l.controller_change(c(this))}),l.$plans.on("change",'select[name$="[availability]"]',function(){var e=c(this).closest(".llms-access-plan"),t=e.find('input[name$="[checkout_redirect_forced]"]'),a=e.find(".llms-checkout-redirect-settings");"members"===c(this).val()?(t.prop("checked")?a.show():a.hide(),t.on("change",function(){a.toggle()})):(t.off("change"),a.show())}),c("#llms-access-plans .llms-access-plan-datepicker").datepicker({dateFormat:"mm/dd/yy"}),c("#llms-access-plans [data-controller-id]").trigger("change"),c("#llms-new-access-plan").on("click",function(){l.init_plan(),l.toggle_create_button("disable"),l.toggle_save_button("enable"),setTimeout(function(){l.has_plan_limit_been_reached()||l.toggle_create_button("enable")},500)}),l.$plans.sortable({handle:".llms-drag-handle",items:".llms-access-plan",start:function(e,t){l.$plans.addClass("dragging")},stop:function(e,t){l.$plans.removeClass("dragging"),l.update_plan_orders()}}),l.$plans.on("keyup","input.llms-plan-title",function(){var e=c(this),t=e.closest(".llms-access-plan").find("span.llms-plan-title"),e=e.val(),e=e||t.attr("data-default");t.text(e)}),l.$plans.on("focusin","input",function(e,t){c(this).addClass("llms-has-been-focused")}),l.$plans.on("keyup focusout llms-validate-plan-field","input",function(e,t){var a=c(this);a[0].checkValidity()?a.removeClass(l.validation_class):(a.addClass(l.validation_class),"keyup"===e.type&&a[0].reportValidity()),t&&!t.cascade||a.closest(".llms-access-plan").trigger("llms-validate-plan",{original_event:e.type})}),l.$plans.on("llms-validate-plan",".llms-access-plan",function(e,t){t=t||{};var a=c(this),t=t.original_event?"input.llms-has-been-focused":"input";a.find(t).each(function(){c(this).trigger("llms-validate-plan-field",{cascade:!1})}),a.find("."+l.validation_class).length?a.addClass(l.validation_class):a.removeClass(l.validation_class)}),l.$plans.on("llms-collapsible-toggled",".llms-access-plan",function(){var e=c(this);e.hasClass("opened")&&setTimeout(function(){e.find("input.llms-invalid").each(function(){c(this)[0].reportValidity()})},500)}),l.$plans.on("click",".llms-plan-delete",function(e){e.stopPropagation(),l.delete_plan(c(this))}),window.llms.metaboxes.post_select(c("#llms-access-plans .llms-availability-restrictions")),window.llms.metaboxes.post_select(c("#llms-access-plans .llms-checkout-redirect-page")),c("#_llms_plans_content_llms-new-access-plan-model").attr("disabled","disabled"),tinyMCE.EditorManager.execCommand("mceRemoveEditor",!0,"_llms_plans_content_llms-new-access-plan-model")},this.bind_visibility=function(){var t=c("#llms-catalog-visibility-select"),a=c("a.llms-edit-catalog-visibility"),e=c("a.llms-save-catalog-visibility"),l=c("a.llms-cancel-catalog-visibility");a.on("click",function(e){e.preventDefault(),t.slideDown("fast"),a.hide()}),e.on("click",function(e){e.preventDefault(),t.slideUp("fast"),a.show(),c("#llms-catalog-visibility-display").text(c('input[name="_llms_visibility"]:checked').attr("data-label"))}),l.on("click",function(e){e.preventDefault(),t.slideUp("fast"),a.show()})},this.delete_plan=function(e){var t=this,a=e.closest(".llms-access-plan"),e=a.attr("data-id"),l=LLMS.l10n.translate("After deleting this access plan, any students subscribed to this plan will still have access and will continue to make recurring payments according to the access plan's settings. If you wish to terminate their plans you must do so manually. This action cannot be reversed.");e?window.confirm(l)&&(LLMS.Spinner.start(a),window.LLMS.Ajax.call({data:{action:"delete_access_plan",plan_id:e},success:function(e){setTimeout(function(){LLMS.Spinner.stop(a)},550),e.success?(t.remove_plan_el(a),t.trigger_update_hook(),setTimeout(function(){t.update_plan_orders()},500)):e.message&&alert(e.message)}})):t.remove_plan_el(a)},this.controller_change=function(e){var t=e.attr("data-controller-id"),i=e.val(),t=e.closest(".llms-access-plan").find('[data-controller="'+t+'"]');"checkbox"===e.attr("type")&&(i=e.is(":checked")?i:"no"),t.each(function(){var e,t,a=c(this),l="SELECT"===a[0].nodeName||"INPUT"===a[0].nodeName||"TEXTAREA"===a[0].nodeName?a:a.find("input, select, textarea"),s=a.attr("data-value-is"),n=a.attr("data-value-is-not");switch(void 0!==s&&!1!==s?t="==":void 0!==n&&!1!==n&&(t="!="),t){case"==":e=i==s?"show":"hide";break;case"!=":e=i!=n?"show":"hide"}"show"===e?(a.show(),l.removeAttr("disabled").trigger("change")):"hide"===e&&(a.hide(),l.attr("disabled","disabled"))})},this.get_current_plan_count=function(){return this.$plans.find(".llms-access-plan").length},this.get_plans_array=function(){tinyMCE.triggerSave();for(var e,t,a,l=this.$plans.closest("form").serializeArray(),s=[],n=0;n<l.length;n++)-1!==l[n].name.indexOf("_llms_plans")&&(e=+(a=l[n].name.replace("_llms_plans[","").split("]["))[0]-1,t=a[1].replace("]",""),a=3===a.length?"array":"single",s[e]||(s[e]={}),"array"==a?(s[e][t]||(s[e][t]=[]),s[e][t].push(l[n].value)):s[e][t]=l[n].value);return s},this.has_plan_limit_been_reached=function(){var e=window.llms.product.access_plan_limit;return this.get_current_plan_count()>=e},this.init_plan=function(){var e;this.has_plan_limit_been_reached()||(e=c("#llms-new-access-plan-model").clone(),$existing_plans=c("#llms-access-plans .llms-access-plan"),$editor=e.find("#_llms_plans_content_llms-new-access-plan-model"),e.removeAttr("id"),$editor.removeAttr("id").attr("id","_llms_plans_content_"+this.temp_id),this.temp_id++,e.find("select, input, textarea").each(function(){c(this).removeAttr("disabled")}),e.find(".llms-access-plan-datepicker").datepicker({dateFormat:"mm/dd/yy"}),e.appendTo("#llms-access-plans"),this.update_plan_orders(),e.find(".llms-collapsible-header").trigger("click"),this.has_plan_limit_been_reached()&&this.toggle_create_button("disable"),window.llms.metaboxes.post_select(e.find(".llms-availability-restrictions")),window.llms.metaboxes.post_select(e.find(".llms-checkout-redirect-page")),e.find("[data-controller-id]").trigger("change"),c(document).trigger("llms-plan-init",e))},this.save_plans=function(){var t=this;if(t.$plans.find(".llms-access-plan").not("#llms-new-access-plan-model").each(function(){c(this).trigger("llms-validate-plan")}),t.$plans.find("."+t.validation_class).length)return t.$plans.find(".llms-access-plan."+t.validation_class).not(".opened").first().find(".llms-collapsible-header").trigger("click"),void c(document).trigger("llms-access-plan-validation-errors");LLMS.Spinner.start(t.$plans),t.$save.attr("disabled","disabled"),window.LLMS.Ajax.call({data:{action:"llms_update_access_plans",plans:t.get_plans_array()},complete:function(){LLMS.Spinner.stop(t.$plans),t.$save.removeAttr("disabled")},error:function(e,t,a){console.error("llms access plan save error encounterd:",e),alert(LLMS.l10n.translate("An error was encountered during the save attempt. Please try again.")+" ["+t+": "+a+"]")},success:function(e){!e.success&&e.code&&"error"===e.code?alert(e.message):e.data&&e.data.html&&(c("#llms-product-options-access-plans").replaceWith(e.data.html),t.init(!0),window.llms.metaboxes.init(),t.update_plan_orders(),t.trigger_update_hook())}})},this.toggle_button=function(e,t){"disable"===t?e.attr("disabled","disabled"):e.removeAttr("disabled")},this.toggle_create_button=function(e){this.toggle_button(c("#llms-new-access-plan"),e)},this.toggle_save_button=function(e){this.toggle_button(this.$save,e)},this.remove_plan_el=function(e){var t=this;e.fadeOut(400),setTimeout(function(){e.remove(),t.has_plan_limit_been_reached()||t.toggle_create_button("enable"),0===t.get_current_plan_count()&&t.toggle_save_button("disable")},450)},this.trigger_update_hook=function(){c(document).trigger("llms-access-plans-updated")},this.update_plan_orders=function(){c("#llms-access-plans .llms-access-plan").each(function(){var e=c(this),t=e.find(".plan-order"),a=e.find('textarea[id^="_llms_plans_content_"]').attr("id"),l=+t.val(),s=e.index(),n=tinyMCE.EditorManager.get(a),n=(n||tinyMCE.EditorManager).settings;n.selector="#"+a,tinyMCE.EditorManager.execCommand("mceRemoveEditor",!0,a),e.find("select, input, textarea").each(function(){var e=c(this).attr("name");e&&c(this).attr("name",e.replace(l,s))}),tinyMCE.EditorManager.init(n),t.val(s)})},this.init()};new window.llms.metabox_product}(jQuery);
//# sourceMappingURL=../maps/js/llms-metabox-product.min.js.map
